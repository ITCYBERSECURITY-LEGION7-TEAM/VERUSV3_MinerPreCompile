#!/bin/bash

# Mining Manager Script dengan Hacker UI/UX
# VIPOR dan LuckPool Support

# Warna untuk UI
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Variabel global
CONFIG_FILE="config.json"
CCMINER_PATH="./ccminer" # Ganti dengan path ccminer Anda

# Pool configurations
VIPOR_POOLS=(
    "sg.vipor.net:5040"
    "eu.vipor.net:5040" 
    "us.vipor.net:5040"
    "jp.vipor.net:5040"
    "au.vipor.net:5040"
    "ca.vipor.net:5040"
    "br.vipor.net:5040"
    "in.vipor.net:5040"
    "kr.vipor.net:5040"
    "ru.vipor.net:5040"
)

LUCKPOOL_POOLS=(
    "na.luckpool.net:3960"
    "eu.luckpool.net:3960"
    "ap.luckpool.net:3960"
    "sa.luckpool.net:3960"
    "ca.luckpool.net:3960"
    "us.luckpool.net:3960"
    "asia.luckpool.net:3960"
    "europe.luckpool.net:3960"
    "america.luckpool.net:3960"
    "australia.luckpool.net:3960"
)

# Fungsi animasi loading hacker
hacker_loading() {
    local duration=$1
    local steps=100
    local delay=$(echo "scale=3; $duration/$steps" | bc)
    
    echo -e "${GREEN}"
    echo "  ██████╗ ██████╗███╗   ███╗██╗███╗   ██╗███████╗██████╗ "
    echo " ██╔════╝██╔════╝████╗ ████║██║████╗  ██║██╔════╝██╔══██╗"
    echo " ██║     ██║     ██╔████╔██║██║██╔██╗ ██║█████╗  ██████╔╝"
    echo " ██║     ██║     ██║╚██╔╝██║██║██║╚██╗██║██╔══╝  ██╔══██╗"
    echo " ╚██████╗╚██████╗██║ ╚═╝ ██║██║██║ ╚████║███████╗██║  ██║"
    echo "  ╚═════╝ ╚═════╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝"
    echo -e "${CYAN}=================================================${NC}"
    echo -e "${YELLOW}          ADVANCED MINING LAUNCHER v2.0${NC}"
    echo -e "${CYAN}=================================================${NC}"
    echo
    echo -e "${NC}"
    
    for ((i=0; i<=steps; i++)); do
        local percent=$((i))
        local filled=$((i/2))
        local empty=$((50-filled))
        
        # Buat progress bar
        local bar="["
        for ((j=0; j<filled; j++)); do
            bar+="█"
        done
        for ((j=0; j<empty; j++)); do
            bar+="░"
        done
        bar+="]"
        
        # Generate random hex codes untuk efek hacker
        local hex1=$(printf '%02X' $((RANDOM % 256)))
        local hex2=$(printf '%02X' $((RANDOM % 256)))
        local hex3=$(printf '%02X' $((RANDOM % 256)))
        
        printf "\r${CYAN}INITIALIZING SYSTEM${NC} ${bar} ${GREEN}%3d%%${NC} | ${YELLOW}0x${hex1}${hex2}${hex3}${NC} | ${PURPLE}ACCESSING MINING NETWORK${NC}" $percent
        sleep $delay
    done
    echo
}

# Fungsi untuk menampilkan header
show_header() {
    clear
    echo -e "${PURPLE}"
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║                   MINING MANAGER v2.0                       ║"
    echo "║                     HACKER EDITION                          ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Fungsi untuk validasi wallet address
validate_wallet() {
    local wallet=$1
    # Basic validation - sesuaikan dengan format coin yang digunakan
    if [[ ${#wallet} -lt 20 ]]; then
        return 1
    fi
    return 0
}

# Fungsi untuk membuat config.json
create_config() {
    local pool=$1
    local wallet=$2
    local worker=$3
    local cpu_usage=$4
    
    cat > $CONFIG_FILE << EOF
{
    "pool": "$pool",
    "wallet": "$wallet",
    "worker": "$worker",
    "cpu_usage": $cpu_usage,
    "algorithm": "verushash",
    "threads": $(nproc),
    "max-temp": 85,
    "auto-restart": true
}
EOF
    echo -e "${GREEN}Config file created: $CONFIG_FILE${NC}"
}

# Fungsi untuk menampilkan menu pool selection
select_pool() {
    local pool_type=$1
    local pools=()
    
    if [ "$pool_type" == "vipor" ]; then
        pools=("${VIPOR_POOLS[@]}")
        echo -e "${CYAN}Select VIPOR Pool:${NC}"
    else
        pools=("${LUCKPOOL_POOLS[@]}")
        echo -e "${CYAN}Select LuckPool Pool:${NC}"
    fi
    
    for i in "${!pools[@]}"; do
        echo -e "${YELLOW}$((i+1)).${NC} ${pools[i]} ${GREEN}[All Countries]${NC}"
    done
    
    local choice
    while true; do
        echo -ne "${WHITE}Enter your choice (1-10): ${NC}"
        read choice
        if [[ $choice =~ ^[1-9]$|^10$ ]]; then
            selected_pool="${pools[$((choice-1))]}"
            break
        else
            echo -e "${RED}Invalid choice! Please enter 1-10${NC}"
        fi
    done
}

# Fungsi mining VIPOR
start_vipor_mining() {
    show_header
    echo -e "${GREEN}=== VIPOR MINING SETUP ===${NC}"
    
    select_pool "vipor"
    
    echo -ne "${WHITE}Enter Wallet Address: ${NC}"
    read wallet
    
    if ! validate_wallet "$wallet"; then
        echo -e "${RED}Invalid wallet address!${NC}"
        return 1
    fi
    
    echo -ne "${WHITE}Enter Worker Name: ${NC}"
    read worker
    
    echo -ne "${WHITE}Enter CPU Usage % (1-100): ${NC}"
    read cpu_usage
    
    if ! [[ $cpu_usage =~ ^[0-9]+$ ]] || [ $cpu_usage -lt 1 ] || [ $cpu_usage -gt 100 ]; then
        echo -e "${RED}Invalid CPU usage! Using default 50%${NC}"
        cpu_usage=50
    fi
    
    # Buat config file
    create_config "$selected_pool" "$wallet" "$worker" "$cpu_usage"
    
    # Tampilkan summary
    echo -e "\n${CYAN}=== MINING CONFIGURATION ===${NC}"
    echo -e "${YELLOW}Pool:${NC} $selected_pool"
    echo -e "${YELLOW}Wallet:${NC} $wallet"
    echo -e "${YELLOW}Worker:${NC} $worker"
    echo -e "${YELLOW}CPU Usage:${NC} $cpu_usage%"
    
    # Animasi loading
    hacker_loading 3
    
    # Start mining
    echo -e "\n${GREEN}Starting CCminer for VIPOR...${NC}"
    $CCMINER_PATH -a verus -o stratum+tcp://$selected_pool -u $wallet.$worker -p x -t $cpu_usage
}

# Fungsi mining LuckPool
start_luckpool_mining() {
    show_header
    echo -e "${GREEN}=== LUCKPOOL MINING SETUP ===${NC}"
    
    select_pool "luckpool"
    
    echo -ne "${WHITE}Enter Wallet Address: ${NC}"
    read wallet
    
    if ! validate_wallet "$wallet"; then
        echo -e "${RED}Invalid wallet address!${NC}"
        return 1
    fi
    
    echo -ne "${WHITE}Enter Worker Name: ${NC}"
    read worker
    
    echo -ne "${WHITE}Enter CPU Usage % (1-100): ${NC}"
    read cpu_usage
    
    if ! [[ $cpu_usage =~ ^[0-9]+$ ]] || [ $cpu_usage -lt 1 ] || [ $cpu_usage -gt 100 ]; then
        echo -e "${RED}Invalid CPU usage! Using default 50%${NC}"
        cpu_usage=50
    fi
    
    # Buat config file
    create_config "$selected_pool" "$wallet" "$worker" "$cpu_usage"
    
    # Tampilkan summary
    echo -e "\n${CYAN}=== MINING CONFIGURATION ===${NC}"
    echo -e "${YELLOW}Pool:${NC} $selected_pool"
    echo -e "${YELLOW}Wallet:${NC} $wallet"
    echo -e "${YELLOW}Worker:${NC} $worker"
    echo -e "${YELLOW}CPU Usage:${NC} $cpu_usage%"
    
    # Animasi loading
    hacker_loading 3
    
    # Start mining
    echo -e "\n${GREEN}Starting CCminer for LuckPool...${NC}"
    $CCMINER_PATH -a verus -o stratum+tcp://$selected_pool -u $wallet.$worker -p x -t $cpu_usage
}

# Fungsi untuk menampilkan status mining
show_mining_status() {
    if [ -f "$CONFIG_FILE" ]; then
        echo -e "${CYAN}=== CURRENT MINING CONFIG ===${NC}"
        cat $CONFIG_FILE | python3 -m json.tool 2>/dev/null || cat $CONFIG_FILE
    else
        echo -e "${YELLOW}No active mining configuration found${NC}"
    fi
}

# Main menu
main_menu() {
    while true; do
        show_header
        echo -e "${WHITE}Select Mining Pool:${NC}"
        echo -e "${GREEN}1.${NC} VIPOR Mining (10 Pools Available)"
        echo -e "${BLUE}2.${NC} LuckPool Mining (10 Pools Available)"
        echo -e "${YELLOW}3.${NC} Show Current Config"
        echo -e "${RED}4.${NC} Exit"
        echo -e "${CYAN}══════════════════════════════════════════════════${NC}"
        
        echo -ne "${WHITE}Enter your choice (1-4): ${NC}"
        read choice
        
        case $choice in
            1)
                start_vipor_mining
                ;;
            2)
                start_luckpool_mining
                ;;
            3)
                show_mining_status
                echo -e "\n${WHITE}Press Enter to continue...${NC}"
                read
                ;;
            4)
                echo -e "${GREEN}Exiting... Happy Mining!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice! Press Enter to continue...${NC}"
                read
                ;;
        esac
    done
}

# Check dependencies
check_dependencies() {
    local deps=("bc" "python3")
    for dep in "${deps[@]}"; do
        if ! command -v $dep &> /dev/null; then
            echo -e "${RED}Error: $dep is not installed${NC}"
            echo -e "${YELLOW}Installing dependencies...${NC}"
            sudo apt-get update && sudo apt-get install -y bc python3
            break
        fi
    done
}

# Check if ccminer exists
if [ ! -f "$CCMINER_PATH" ]; then
    echo -e "${RED}Error: CCminer not found at $CCMINER_PATH${NC}"
    echo -e "${YELLOW}Please update CCMINER_PATH variable in the script${NC}"
    exit 1
fi

# Initial setup
check_dependencies
chmod +x $CCMINER_PATH

# Start main program
main_menu
